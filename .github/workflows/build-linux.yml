on:
  workflow_call:
    inputs:
      dartSdkVersion:
        type: string
        required: false
        default: stable
        description: The Dart-SDK version. Passed as "sdk" to "dart-lang/setup-dart".
      flatpakSdkVersion:
        type: string
        required: false
        default: "23.08"
        description: The version of the freedesktop sdk and runtime being used.
      bundleName:
        type: string
        required: true
        description: The output flatpak bundle name.
      workingDirectory:
        type: string
        required: false
        default: .
        description: The root directory of the dart package to build and test.
      artifactDependencies:
        type: string
        required: false
        default: ""
        description: A space-separated list of package names that should be downloaded from the artifacts and overwritten for the workflow. The packages should be space separated and placed in a single line. You can use the YAML ">-" for that.
      buildNumberArgs:
        type: string
        required: false
        default: ""
        description: Additional args for the build number generator.
      manifestPath:
        type: string
        required: true
        description: The path to the flatpak manifest to be built.
    secrets:
      gpgKey:
        required: true
        description: The GPG key to sign the flatpak bundle and repository with.
      gpgKeyId:
        required: true
        description: The id of the gpgKey
jobs:
  build_linux:
    name: Build linux flatpak bundle
    environment: flatpak
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
          - aarch64
        include:
          - arch: aarch64
            qemuArch: arm64
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-${{ inputs.flatpakSdkVersion }}
      options: --privileged
    steps:
      - name: Install Dart-SDK (${{ inputs.dartSdkVersion }})
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ inputs.dartSdkVersion }}
      - name: Install dart_test_tools
        run: dart pub global activate dart_test_tools ^5.9.0
      - name: Install docker
        if: matrix.qemuArch
        run: dnf -y install docker
      - name: Setup QEMU
        if: matrix.qemuArch
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.qemuArch }}
      - name: Print disk usage
        if: always()
        continue-on-error: true
        run: df
      - name: Download flatpak flutter SDK
        run: curl --fail-with-body -L -o /tmp/flutter.flatpak 'https://github.com/Skycoder42/dart_test_tools/releases/download/flatpak-flutter-extension%2F${{ inputs.flatpakSdkVersion }}/org.freedesktop.Sdk.Extension.flutter_${{ inputs.flatpakSdkVersion }}_${{ matrix.arch }}.flatpak'
      - name: Install flatpak flutter SDK
        run: flatpak install --system -y --noninteractive /tmp/flutter.flatpak
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Download artifacts
        if: inputs.artifactDependencies != ''
        uses: actions/download-artifact@v4
        with:
          pattern: package-*
          path: ${{ github.workspace }}/.artifacts
      - id: generateBuildNumber
        name: Generate build number
        run: dart pub global run dart_test_tools:generate_build_number ${{ inputs.buildNumberArgs }} --env
        working-directory: ${{ inputs.workingDirectory }}
      - name: Import GPG key
        run: echo '${{ secrets.gpgKey }}' | gpg --import
      - name: Prepare ostree repo
        run: |
          set -eo pipefail
          ostree init --mode=archive --repo=repo
          ostree --repo=repo config set core.min-free-space-size "1MB"
      - name: Build flatpak bundle
        uses: bilelmoussaoui/flatpak-github-actions/flatpak-builder@86f5f35aa999f626a05d2943460ff0e811655327
        with:
          bundle: ${{ inputs.bundleName }}
          manifest-path: ${{ inputs.workingDirectory }}/${{ inputs.manifestPath }}
          branch: ${{ github.ref_name }}
          arch: ${{ matrix.arch }}
          gpg-sign: ${{ secrets.gpgKeyId }}
          cache: false
          upload-artifact: false
      - name: Print disk usage
        if: always()
        continue-on-error: true
        run: df
      - name: Delete GPG key
        if: always()
        continue-on-error: true
        run: gpg --batch --yes --delete-secret-keys '${{ secrets.gpgKeyId }}'
      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle-${{ matrix.arch }}
          path: ${{ inputs.bundleName }}
          compression-level: 0
          if-no-files-found: error
          retention-days: 1
